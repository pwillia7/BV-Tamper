"use strict";function insertSiblingBefore(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{functiontoInvoke:"insertSiblingBefore"}),console.log("message sent")})}function insertSiblingAfter(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{functiontoInvoke:"insertSiblingAfter"})})}function insertFirstChild(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{functiontoInvoke:"insertFirstChild"})})}function insertLastChild(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{functiontoInvoke:"insertLastChild"})})}function insertParent(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{functiontoInvoke:"insertParent"})})}function insertSiblingBeforeSummary(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{functiontoInvoke:"insertSiblingBeforeSummary"}),console.log("message sent")})}function insertSiblingAfterSummary(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{functiontoInvoke:"insertSiblingAfterSummary"})})}function insertFirstChildSummary(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{functiontoInvoke:"insertFirstChildSummary"})})}function insertLastChildSummary(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{functiontoInvoke:"insertLastChildSummary"})})}function insertParentSummary(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(a){chrome.tabs.sendMessage(a[0].id,{functiontoInvoke:"insertParentSummary"})})}function showFirstRunMessage(){localStorage.getItem("installTime")||(localStorage.setItem("installTime",(new Date).getTime()),chrome.tabs.create({url:"first-run.html"}))}function sendMessageToAllPorts(a){for(var b=0;b<ports.length;b++)console.log("Sending message ",a,"to port",ports[b]),ports[b].postMessage(a)}function updateProxyConfig(){settings.isProxyEnabled&&proxyState===PROXY_STARTED?chrome.proxy.settings.set({value:{mode:"pac_script",pacScript:{data:settings.pacScript.replace("%%PORT%%",settings.proxyPort)}},scope:"regular"},function(){}):chrome.proxy.settings.set({value:config.system,scope:"regular"},function(){}),localStorage.setItem("isProxyEnabled",settings.isProxyEnabled)}function updateProxyIcon(){proxyState!==PROXY_STARTED?(chrome.browserAction.setIcon({path:{19:"images/icon_error.png",38:"images/icon_error@2x.png"}}),chrome.browserAction.setTitle({title:"Error starting proxy"})):settings.isProxyEnabled?(chrome.browserAction.setIcon({path:{19:"images/icon_on.png",38:"images/icon_on@2x.png"}}),chrome.browserAction.setTitle({title:"Tamper is enabled"})):(chrome.browserAction.setIcon({path:{19:"images/icon_off.png",38:"images/icon_off@2x.png"}}),chrome.browserAction.setTitle({title:"Tamper is disabled"}))}function onProxyStateChange(){updateProxyConfig(),updateProxyIcon(),sendMessageToAllPorts({method:"proxy-state-update",isProxyEnabled:settings.isProxyEnabled,proxyState:proxyState})}function toggleProxy(){settings.isProxyEnabled=!settings.isProxyEnabled,onProxyStateChange()}function connectToProxy(){console.log("connecting to proxy"),nativeMessagingPort=chrome.runtime.connectNative("com.dutzi.tamper"),setTimeout(function(){nativeMessagingPort&&(nativeMessagingPort.postMessage({method:"hello"}),nativeMessagingPort.postMessage({method:"start-proxy",port:settings.proxyPort}),nativeMessagingPort.postMessage({method:"update-rules",rules:JSON.parse(localStorage.getItem("rules"))}))},1e3),nativeMessagingPort.onMessage.addListener(function(a){"log"!==a.msg.method&&console.log("Got message: ",a.msg);var b=proxyState;switch(proxyState!==PROXY_CONNECTED&&proxyState!==PROXY_STARTED&&(proxyState=PROXY_CONNECTED),a.msg.method){case"log":console.log("Proxy Log:",a.msg.message);break;case"version":console.log("Mitmproxy Extension Version: "+a.msg.version),localStorage.setItem("mitmproxyExtensionVersion",a.msg.version);break;case"proxy-error":switch(console.error("Proxy Error ("+a.msg.errorCode+"): "+a.msg.errorDesc),a.msg.errorCode){case 100:proxyState=PROXY_COULD_NOT_START_PORT_ERROR;break;case 101:proxyState=PROXY_COULD_NOT_START_LIBS_ERROR}break;case"proxy-started":proxyState=PROXY_STARTED;break;default:sendMessageToAllPorts(a.msg)}b!==proxyState&&onProxyStateChange()}),nativeMessagingPort.onDisconnect.addListener(function(){console.log("Disconnected"),proxyState!==PROXY_COULD_NOT_START_LIBS_ERROR&&(proxyState=PROXY_DISCONNECTED,nativeMessagingPort=null,onProxyStateChange(),setTimeout(connectToProxy,1e3))})}for(var menuItems=[["Summary: Insert as Sibling Before",insertSiblingBeforeSummary],["Summary: Insert as Sibling After",insertSiblingAfterSummary],["Summary: Insert as First Child",insertFirstChildSummary],["Summary: Insert as Last Child",insertLastChildSummary],["Summary: Insert as Parent",insertParentSummary],["Main: Insert as Sibling Before",insertSiblingBefore],["Main: Insert as Sibling After",insertSiblingAfter],["Main: Insert as First Child",insertFirstChild],["Main: Insert as Last Child",insertLastChild],["Main: Insert as Parent",insertParent]],contexts=["page","selection","link","editable","image","video","audio"],i=0;i<menuItems.length;i++)var id=chrome.contextMenus.create({title:menuItems[i][0],contexts:contexts,onclick:menuItems[i][1]});var PROXY_NOT_CONNECTED="not connected",PROXY_COULD_NOT_START_PORT_ERROR="could not start port error",PROXY_COULD_NOT_START_LIBS_ERROR="could not start libs error",PROXY_STARTED="proxy started",PROXY_CONNECTED="proxy connected",PROXY_DISCONNECTED="proxy disconnected",nativeMessagingPort,couldNotStartProxy;showFirstRunMessage();var settings={},defaultSettings={isProxyEnabled:!0,pacScript:'function FindProxyForURL(url, host) {\n    if (host == "localhost")\n        return "DIRECT";\n    return "PROXY localhost:%%PORT%%";\n}',sidebarWidth:"250px",editorCommandLine:"",proxyPort:8080};for(var key in defaultSettings)localStorage.getItem(key)?settings[key]=localStorage.getItem(key):(settings[key]=defaultSettings[key],localStorage.setItem(key,settings[key])),localStorage.setItem("default."+key,defaultSettings[key]);localStorage.getItem("rules")||localStorage.setItem("rules","[]");var proxyState=PROXY_NOT_CONNECTED,config={system:{mode:"system"},tamper:{mode:"fixed_servers",rules:{proxyForHttp:{host:"localhost",port:8889},proxyForHttps:{host:"localhost",port:8889},bypassList:["localhost:8001","localhost:35729"]}}};chrome.proxy.settings.set({value:config.system,scope:"regular"},function(){});var openCount=0,ports=[];chrome.runtime.onConnect.addListener(function(a){console.log(a),"devtools-page"===a.name&&(openCount++,console.log("hye"),ports.push(a),onProxyStateChange(),a.onDisconnect.addListener(function(a){console.log("bye"),openCount--,ports.splice(ports.indexOf(a),1),onProxyStateChange()}),a.onMessage.addListener(function(a){switch(a.method){case"update-settings":settings.editorCommandLine=localStorage.getItem("editorCommandLine"),settings.pacScript=localStorage.getItem("pacScript"),settings.proxyPort=localStorage.getItem("proxyPort"),updateProxyConfig(),updateProxyIcon();break;default:console.log("Posting message to proxy",a),nativeMessagingPort.postMessage(a)}})),console.log("sending proxy state update",settings.isProxyEnabled,proxyState),a.postMessage({method:"proxy-state-update",isProxyEnabled:settings.isProxyEnabled,proxyState:proxyState})}),chrome.runtime.onMessage.addListener(function(a){switch(console.log(a),a.method){case"toggle-proxy":settings.isProxyEnabled=a.isEnabled,onProxyStateChange()}}),chrome.browserAction.onClicked.addListener(function(){toggleProxy()}),chrome.commands.onCommand.addListener(function(a){"toggle-tamper"===a&&toggleProxy()}),connectToProxy(),settings.isProxyEnabled="true"===localStorage.getItem("isProxyEnabled"),onProxyStateChange();